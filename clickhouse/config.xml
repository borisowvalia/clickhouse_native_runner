<!--
  NOTE: User and query level settings are set up in "users.xml" file.
  If you have accidentally specified user-level settings here, server won't start.
  You can either move the settings to the right place inside "users.xml" file
   or add <skip_check_for_incorrect_settings>1</skip_check_for_incorrect_settings> here.
-->
<clickhouse>
    <logger>
        <!-- Отключаем логирование в файл -->
        <level>none</level>
        <log>/dev/null</log>
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
        <size>0</size>
        <count>0</count>
    </logger>

    <http_port from_env="PORT"/>
    <tcp_port>9000</tcp_port>
    <interserver_http_port>9009</interserver_http_port>

    <!-- Путь хранения данных -->
    <path>/var/lib/clickhouse/</path>
    <tmp_path>/tmp/clickhouse/</tmp_path>

    <!-- Временные таблицы и кэш -->
    <mark_cache_size>0</mark_cache_size>
    <uncompressed_cache_size>0</uncompressed_cache_size>
    <query_cache_size>0</query_cache_size>

    <remote_servers>
        <default>
            <shard>
                <replica>
                    <host>localhost</host>
                    <port>9000</port>
                </replica>
            </shard>
        </default>
    </remote_servers>

    <!-- Максимальная параллельность и быстродействие -->
    <max_threads>8</max_threads>
    <max_memory_usage>1000000000</max_memory_usage>
    <max_bytes_before_external_group_by>0</max_bytes_before_external_group_by>
    <max_bytes_before_external_sort>0</max_bytes_before_external_sort>

    <!-- Системные таблицы и метрики -->
    <enable_http_compression>0</enable_http_compression>
    <track_metrics>0</track_metrics>
    <track_memory_usage>0</track_memory_usage>
    <background_pool_size>1</background_pool_size>

    <!-- Отключаем MergeTree фоновое слияние для быстрого старта -->
    <merge_tree>
        <parts_to_throw_insert>1000000</parts_to_throw_insert>
        <parts_to_throw_select>1000000</parts_to_throw_select>
        <parts_to_throw_merge>1000000</parts_to_throw_merge>
    </merge_tree>

    <distributed_ddl>
        <path>/clickhouse/task_queue/ddl</path>
        <replicas_path>/clickhouse/task_queue/replicas</replicas_path>
    </distributed_ddl>

    <!-- Минимальные настройки users.xml -->
    <user_directories>
        <users_xml>
            <path>users.xml</path>
        </users_xml>
        <local_directory>
            <path>/var/lib/clickhouse/access/</path>
        </local_directory>
    </user_directories>

    <access_control_improvements>
        <users_without_row_policies_can_read_rows>true</users_without_row_policies_can_read_rows>
        <on_cluster_queries_require_cluster_grant>true</on_cluster_queries_require_cluster_grant>
        <select_from_system_db_requires_grant>true</select_from_system_db_requires_grant>
        <select_from_information_schema_requires_grant>true</select_from_information_schema_requires_grant>
        <settings_constraints_replace_previous>true</settings_constraints_replace_previous>
        <table_engines_require_grant>false</table_engines_require_grant>
        <role_cache_expiration_time_seconds>600</role_cache_expiration_time_seconds>
    </access_control_improvements>

    <user_files_path>/var/lib/clickhouse/user_files/</user_files_path>
<clickhouse>